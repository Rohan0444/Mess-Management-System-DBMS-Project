1. FUNCTION for No. of students in a mess
CREATE FUNCTION count_students_in_mess(mid INT)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE total INT;
    SELECT COUNT(*) INTO total
    FROM STUDENT
    WHERE Mess_id = mid;
    RETURN total;
END;
//


2. Procedure: Add Daily Menu Item
CREATE PROCEDURE AddDailyMenuItem (
    IN messid INT,
    IN day_name VARCHAR(10),
    IN itemid INT,
    IN dish VARCHAR(50),
    IN category VARCHAR(30),
    IN mealtype VARCHAR(30)
)
BEGIN
    INSERT INTO DAILY_MENU (Mess_id, Day, ItemId, DishName, Category, MealType)
    VALUES (messid, day_name, itemid, dish, category, mealtype);
END;
//


3. Trigger: Ensure ratings are within valid range
CREATE TRIGGER check_rating_before_insert
BEFORE INSERT ON FEEDBACK
FOR EACH ROW
BEGIN
    IF NEW.Rating < 1 OR NEW.Rating > 5 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Rating must be between 1 and 5';
    END IF;
END;
//


4. Procedure: Get best-rated mess
CREATE PROCEDURE GetBestRatedMess()
BEGIN
    SELECT M.id, M.Name, ROUND(AVG(F.Rating), 2) AS Avg_Rating
    FROM MESS M
    JOIN FEEDBACK F ON M.id = F.Mess_id
    GROUP BY M.id, M.Name
    HAVING Avg_Rating = (
        SELECT MAX(avg_rating)
        FROM (
            SELECT AVG(Rating) AS avg_rating
            FROM FEEDBACK
            GROUP BY Mess_id
        ) AS subquery
    );
END;
//
 -- {To use:  CALL GetBestRatedMess();  }

5. Trigger: Prevent inserting workers without rule
CREATE TRIGGER check_worker_role
BEFORE INSERT ON WORKERS
FOR EACH ROW
BEGIN
    IF NEW.Role IS NULL OR TRIM(NEW.Role) = '' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Worker role cannot be empty.';
    END IF;
END;
//

6. Procedure: vendor-total-earnings
CREATE OR REPLACE PROCEDURE vendor_total_earnings IS
BEGIN
    FOR rec IN (
        SELECT v.Name AS Vendor_Name, SUM(p.Amount) AS Total_Earnings
        FROM VENDOR v
        JOIN PAYMENT p ON v.id = p.Vendor_id
        GROUP BY v.Name
    ) LOOP
        DBMS_OUTPUT.PUT_LINE('Vendor: ' || rec.Vendor_Name || ', Total Earnings: â‚¹' || rec.Total_Earnings);
    END LOOP;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
//

7. Procedure - last_contract_day
CREATE OR REPLACE PROCEDURE get_last_contract_day (
    p_mess_id IN MESS.id%TYPE,
    p_due_date OUT DATE
) AS
BEGIN
    SELECT DueDate INTO p_due_date
    FROM MESS
    WHERE id = p_mess_id;

    DBMS_OUTPUT.PUT_LINE('Last day of contract: ' || TO_CHAR(p_due_date, 'DD-MON-YYYY'));
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('No mess found with the given ID.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
//
